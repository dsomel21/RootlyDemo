<%#
  Card component for displaying metadata about an incident.
  NOTE: For `incident.active?`, we add a subtle glow and pulse to the card.
%>

<div class="group relative overflow-hidden rounded-xl border <%= severity_border %> bg-gray-900/50 backdrop-blur-sm hover:bg-gray-800/60 transition-all duration-300 hover:scale-[1.02] hover:shadow-xl <%= incident.active? ? 'shadow-[0_0_20px_rgba(239,68,68,0.4)] animate-pulse-subtle' : '' %>">
  <% if incident.active? %>
    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-red-500/5 to-transparent opacity-0 animate-pulse-slow"></div>
  <% end %>

  <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>

  <div class="relative p-6">
    <div class="flex items-start justify-between mb-4">
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold <%= severity_pill_class %> border">
          <%= incident.severity&.upcase || 'SEV2' %>
        </span>

        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium <%= status_pill_class %> border">
          <%= incident.status&.capitalize || 'Unknown' %>
        </span>
      </div>

      <div class="flex items-center text-xs text-gray-400">
        <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <%= time_ago_in_words(incident.created_at) %> ago
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-bold text-white mb-2 leading-tight">
        <span class="text-gray-400 font-mono text-sm mr-2">#<%= incident.number %></span>
        <span class="<%= incident.active? ? 'text-red-200' : '' %>"><%= incident.title %></span>
      </h3>

      <% if incident.description.present? %>
        <p class="text-gray-300 text-sm leading-relaxed line-clamp-3">
          <%= incident.description %>
        </p>
      <% end %>
    </div>

    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <span class="text-xs text-gray-400 mr-3">Team:</span>
        <div class="flex -space-x-2">
          <% if incident.slack_creator&.avatar_url.present? %>
            <img src="<%= incident.slack_creator.avatar_url %>"
                 alt="<%= incident.slack_creator.display_name || 'Commander' %>"
                 class="w-8 h-8 rounded-full border-2 border-gray-700 bg-gray-800 hover:scale-110 transition-transform duration-200">
          <% else %>
            <div class="w-8 h-8 rounded-full border-2 border-gray-700 bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white">
              <%= commander_initial.upcase %>
            </div>
          <% end %>

          <div class="w-8 h-8 rounded-full border-2 border-gray-700 bg-gray-600 flex items-center justify-center text-xs font-bold text-white">
            +2
          </div>
        </div>
      </div>

      <div class="flex items-center space-x-3">
        <div class="flex items-center space-x-2">
        <% if incident.slack_channel %>
          <%= link_to incident.slack_channel.slack_deep_link,
                target: "_blank",
                rel: "noopener noreferrer",
                class: "inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium bg-transparent text-gray-300 hover:bg-gray-700/50 active:scale-95 active:bg-gray-800/60 transition-all duration-150 border border-gray-500/50 hover:border-gray-400/70 hover:shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:ring-offset-2 focus:ring-offset-gray-900",
                "aria-label" => "Open incident #inc-#{incident.number.to_s.rjust(4, '0')} in Slack" do %>
              <svg class="mr-1.5 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" aria-hidden="true">
                <path d="M94.1 315.1c0 25.9-21.2 47.1-47.1 47.1S0 341 0 315.1 21.2 268 47.1 268l47.1 0 0 47.1zm23.7 0c0-25.9 21.2-47.1 47.1-47.1S212 289.2 212 315.1l0 117.8c0 25.9-21.2 47.1-47.1 47.1s-47.1-21.2-47.1-47.1l0-117.8zm47.1-189c-25.9 0-47.1-21.2-47.1-47.1S139 32 164.9 32 212 53.2 212 79.1l0 47.1-47.1 0zm0 23.7c25.9 0 47.1 21.2 47.1 47.1S190.8 244 164.9 244L47.1 244C21.2 244 0 222.8 0 196.9s21.2-47.1 47.1-47.1l117.8 0zm189 47.1c0-25.9 21.2-47.1 47.1-47.1S448 171 448 196.9 426.8 244 400.9 244l-47.1 0 0-47.1zm-23.7 0c0 25.9-21.2 47.1-47.1 47.1S236 222.8 236 196.9l0-117.8C236 53.2 257.2 32 283.1 32s47.1 21.2 47.1 47.1l0 117.8zm-47.1 189c25.9 0 47.1 21.2 47.1 47.1S309 480 283.1 480 236 458.8 236 432.9l0-47.1 47.1 0zm0-23.7c-25.9 0-47.1-21.2-47.1-47.1S257.2 268 283.1 268l117.8 0c25.9 0 47.1 21.2 47.1 47.1s-21.2 47.1-47.1 47.1l-117.8 0z"/>
              </svg>
              <span>#inc-<%= incident.number.to_s.rjust(4, '0') %></span>
            <% end %>
        <% end %>

          <%= link_to "/incidents/#{incident.slug}",
                class: "inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium text-white #{incident.status == 'resolved' ? 'bg-purple-600/20 hover:bg-purple-600/40 active:scale-95 active:bg-purple-600/50 border border-purple-400/50' : 'bg-red-600/20 hover:bg-red-600/40 active:scale-95 active:bg-red-600/50 border border-red-400/50'} transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-offset-2 #{incident.status == 'resolved' ? 'focus:ring-purple-500' : 'focus:ring-red-500'} focus:ring-offset-gray-900",
                data: { turbo_frame: "_top" },
                "aria-label" => "#{contextual_cta} for incident #inc-#{incident.number.to_s.rjust(4, '0')}" do %>
            <span class="sm:hidden"><%= incident.status == "resolved" ? "Review" : "Open" %></span>
            <span class="hidden sm:inline"><%= contextual_cta %></span>
            <svg class="ml-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          <% end %>
        </div>
      </div>
    </div>

    <div class="mt-4 pt-4 border-t border-gray-700/50 flex items-center justify-between text-xs text-gray-400">
      <div class="flex items-center space-x-4">
        <% if incident.slack_creator %>
          <span class="flex items-center">
            <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <%= incident.slack_creator.display_name.presence || incident.slack_creator.real_name.presence || "Unknown User" %>
          </span>
        <% end %>

        <% if duration_text %>
          <span class="flex items-center text-gray-300">
            <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Resolved in&nbsp;<span class="font-bold"><%= duration_text %></span>
          </span>
        <% end %>
      </div>
    </div>
  </div>
</div>
